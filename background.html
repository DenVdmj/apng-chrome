<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8">
    <script src="lib/udeferred.js"></script>
    <script src="lib/crc32.js"></script>
    <script src="lib/misc.js"></script>
    <script src="apng-parser.js"></script>
    <script>
        chrome.extension.onRequest.addListener(function(request, sender, callback) {
            if (request.action == "loadAndParse") {
                var url = request.data;
                Deferred.pipeline(url)(loadBytes, parseAPNG)
                    .done(function(aPng) { callback({"url": url, "ok": true, "apng": aPng}); })
                    .fail(function(reason) { callback({"url": url, "ok": false, "reason": reason}); });

            } else if (request.action == "checkHostname") {
                var enabled = checkHostname(request.data);
                chrome.browserAction.setIcon({
                    "tabId":    sender.tab.id,
                    "path":     enabled ? "img/apng-logo-19-on.png" : "img/apng-logo-19-off.png"
                });
                callback(enabled);
            } else if (request.action == "apngFound" && request.data > 0) {
                chrome.browserAction.setIcon({
                    "tabId":    sender.tab.id,
                    "path":     "img/apng-logo-19-found.png"
                });
                chrome.browserAction.setBadgeText({
                    "tabId":    sender.tab.id,
                    "text":     request.data.toString()
                });
            }
        });

        function loadBytes(url) {
            if (url.substr(0,5) == "data:") return loadDataUrl(url);
            var d = new Deferred();
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = "arraybuffer";
            xhr.onload = function() {
                if (this.status == 200) {
                    d.resolve({
                        "isPng":        isPng(this),
                        "isFromCache":  isFromCache(this),
                        "contentType":  this.getResponseHeader("Content-Type"),
                        "bytes":        new Uint8Array(this.response)
                    });
                } else {
                    d.reject(url + ": " + xhr.statusText);
                }
            };
            xhr.send();
            return d.promise();
        }

        function loadDataUrl(url) {
            var d = new Deferred();

            var parts = url.substr(5).split(",", 2);
            parts[0] = parts[0].split(";");
            var data = parts[1], mime = parts[0][0], enc = parts[0][parts[0].length - 1];

            var result = {
                "isPng":        (mime.indexOf("image/png") === 0),
                "isFromCache":  true,
                "contentType":  mime,
                "bytes":        null
            };

            if (result.isPng) {
                var str = (enc == "base64") ? atob(data) : unescape(data);
                var bytes = new Uint8Array(str.length);
                for (var i = 0; i < str.length; i++) bytes[i] = str.charCodeAt(i);
                result.bytes = bytes;
            }
            d.resolve(result);

            return d.promise();
        }

        function checkHostname(hostname) {
            var mode = localStorage["mode"];
            if (mode != "white") mode = "black";
            var list = localStorage[mode + "List"];
            var hostNames = list ? list.toLowerCase().split(/[^a-z0-9.-]+/) : [];
            var inList = (hostNames.indexOf(hostname.toLowerCase()) !== -1);

            return (mode == "black") ? !inList : inList;
        }

        function isPng(xhr) {
            var h = xhr.getResponseHeader("Content-Type");
            return (h !== null && h.indexOf("image/png") === 0);
        }

        function isFromCache(xhr) {
            var h;
            h = xhr.getResponseHeader("Cache-Control");
            if (h !== null && (
                    h.indexOf("no-cache") != -1 ||
                    h.indexOf("no-store") != -1 ||
                    h.indexOf("must-revalidate") != -1
                    )) return false;

            h = xhr.getResponseHeader("Pragma");
            if (h !== null &&
                    h.indexOf("no-cache") != -1
                    ) return false;

            h = xhr.getResponseHeader("Expires");
            if (h !== null &&
                    new Date(h) <= new Date()
                    ) return false;

            return true;
        }

    </script>
</head>
<body>
</body>
</html>